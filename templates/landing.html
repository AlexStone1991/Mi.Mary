
{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Шапка с баннером -->
<section class="text-center py-5">
    <div class="container">
        <h1 class="display-4 text-black animate__animated animate__fadeInDown"
            style="font-family: 'Dancing Script', cursive; font-size: 13rem;">
            Mi Mary
        </h1>
    </div>
</section>
<!-- Раздел "Студия красоты в Новомосковске" -->
<section class="py-5">
    <div class="container">
        <h2 class="text-center mb-4 animate__animated animate__fadeInUp">Студия красоты в Новомосковске</h2>
        <div class="row">
            <div class="col-md-6 animate__animated animate__fadeInLeft">
                <img src="{% static 'images/eyes_butterflies2.jpg' %}" alt="Mi Mary" class="img-fluid rounded shadow">
            </div>
            <div class="col-md-6 text-end animate__animated animate__fadeInRight">
                <h4>Добро пожаловать в салон красоты "Mi Mary"! Мы специализируемся на создании неповторимого образа для каждого клиента.</h4>
                <h4>Наш Мастер используют только профессиональные средства и современные техники.</h4>
                <h4>Вы всегда красивы, а мы поможем вам сиять ещё ярче!</h4>
            </div>
        </div>
    </div>
</section>

<!-- Раздел "Услуги" -->
<section class="py-5" id="service_list">
    <div class="container mt-4">
        <h2 class="text-center mb-4 animate__animated animate__fadeInUp">Наши услуги</h2>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            {% for category in categories %}
            <div class="col">
                <div class="border border-dark rounded-3 card h-100 service-card animate__animated animate__fadeInUp">
                    {% if category.image %}
                    <img src="{{ category.image.url }}" class="card-img-top" alt="{{ category.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center" style="height: 200px; background-color: transparent;">
                        <i class="bi bi-scissors fs-1 text-muted"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title text-center fs-1">{{ category.name }}</h5>
                        {% if category.description %}
                        <p class="card-text">{{ category.description }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% url 'category_services' category.id %}" class="btn btn-custom w-100">
                            <i class="bi bi-arrow-right"></i> Подробнее
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Окошки для записи -->
<section id="free-slots" class="py-5">
    <div class="container">
        <h2 class="text-center mb-4 animate__animated animate__fadeInUp">Свободные окошки для записи</h2>
        
        <div class="free-slots-container" style="column-count: 2; column-gap: 20px;"> 
            {% for slot in free_slots %}
            <div class="col">
                <div class="card h-100 border-0 shadow-sm mb-3 slot-card" style="break-inside: avoid;">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">{{ slot.date_time|date:"d.m.Y" }}</h5>
                            <h6 class="card-text text-muted mb-0">{{ slot.date_time|time:"H:i" }}</h6>
                        </div>
                        
                        <div>
                            <button type="button" class="btn btn-dark d-none d-md-inline-block"
                                    data-bs-toggle="modal" data-bs-target="#orderModal"
                                    data-slot-id="{{ slot.id }}"
                                    data-slot-datetime="{{ slot.date_time|date:'Y-m-d' }}T{{ slot.date_time|time:'H:i' }}">
                                Записаться
                            </button>
                            <button type="button" class="btn btn-dark d-md-none"
                                    data-bs-toggle="modal" data-bs-target="#orderModal"
                                    data-slot-id="{{ slot.id }}"
                                    data-slot-datetime="{{ slot.date_time|date:'Y-m-d' }}T{{ slot.date_time|time:'H:i' }}">
                                <i class="bi bi-calendar-plus fs-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Модальное окно записи -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Запись на услуги</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_appointment_date" class="form-label">Дата и время</label>
                        <input type="datetime-local" class="form-control" id="id_appointment_date" name="appointment_date" required readonly>
                    </div>
                    <div class="mb-3">
                        <label for="id_client_name" class="form-label">Ваше имя</label>
                        <input type="text" class="form-control" id="id_client_name" name="client_name" placeholder="Введите ваше имя" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_phone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="id_phone" name="phone" placeholder="+7 (999) 999-99-99" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Выберите категорию услуг</label>
                        <div class="border p-3 rounded bg-light">
                            {% for category in categories %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="category" id="category_{{ category.id }}" value="{{ category.id }}">
                                <label class="form-check-label" for="category_{{ category.id }}">
                                    {{ category.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3" id="servicesContainer" style="display: none;">
                        <label class="form-label">Выберите услуги</label>
                        <div class="border p-3 rounded bg-light" id="servicesList">
                            </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_comment" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="id_comment" name="comment" rows="3" placeholder="Введите комментарий"></textarea>
                    </div>
                    <button type="submit" class="btn btn-dark w-100" id="submitButton" disabled>
                        <i class="bi bi-check-circle"></i> Подтвердить запись
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<section class="py-5" id="reviews">
    <div class="container">
        <h2 class="text-center mb-4 animate__animated animate__fadeInUp">Отзывы</h2>
        <div class="row">
            {% for review in reviews %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 review-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <h5 class="card-title mb-0">{{ review.client_name }}</h5>
                            <div class="ms-auto">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <p class="card-text">{{ review.text }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if not show_all and total_reviews > 6 %}
        <div class="text-center mt-4">
            <a href="?show_all=true" class="btn btn-outline-primary">Показать все отзывы</a>
        </div>
        {% endif %}
    </div>
</section>

<footer class="bg-dark text-white py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-3">
                <h5>Mi Mary</h5>
                <p>Студия красоты</p>
                <p><i class="bi bi-geo-alt"></i> Ул. Маяковского, 25, офис 232, Новомосковск</p>
            </div>
            <div class="col-md-4 mb-3">
                <h5>Контакты</h5>
                <p><i class="bi bi-telephone"></i> <a href="tel:+79509696635" class="text-white">+7 (950) 969-66-35</a></p>
                <p><i class="bi bi-envelope"></i> mi.mary.nmsk@mail.ru</p>
            </div>
            <div class="col-md-4 mb-3">
                <h5>Социальные сети</h5>
                <p><i class="bi bi-telegram"></i> <a href="https://t.me/mi_mary_nmsk" class="text-white">Telegram</a></p>
                <p><i class="bi bi-vk"></i> <a href="https://vk.com/mi.mary.nmsk71" class="text-white">VK</a></p>
            </div>
        </div>
        <div class="text-center mt-3">
            <p class="mb-0">&copy; 2025 Mi Mary. Все права защищены.</p>
        </div>
    </div>
</footer>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderModal = document.getElementById('orderModal');
    const orderForm = document.getElementById('orderForm');
    const servicesContainer = document.getElementById('servicesContainer');
    const servicesList = document.getElementById('servicesList');
    const submitButton = document.getElementById('submitButton');

    // Обработчик открытия модального окна
    orderModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const slotDatetime = button.getAttribute('data-slot-datetime');
        document.getElementById('id_appointment_date').value = slotDatetime;
    });

    // Обработчик выбора категории
    document.querySelectorAll('input[name="category"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const categoryId = this.value;
            fetch(`/api/category-services/${categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    servicesList.innerHTML = '';
                    data.services.forEach(service => {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" name="services" value="${service.id}" id="service_${service.id}">
                            <label class="form-check-label" for="service_${service.id}">
                                ${service.name} (${service.price} руб.)
                            </label>
                        `;
                        servicesList.appendChild(div);
                    });
                    servicesContainer.style.display = 'block';
                    submitButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    });

    // Обработчик отправки формы
    orderForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(orderForm);
        fetch("{% url 'create_order' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': orderForm.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const slotId = document.querySelector('[data-slot-id]').getAttribute('data-slot-id');
                fetch(`/api/book-slot/${slotId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': orderForm.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(() => {
                    window.location.href = "{% url 'thanks' 'create_order' %}";
                });
            } else {
                alert("Произошла ошибка. Проверьте данные и попробуйте снова.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Произошла ошибка. Проверьте данные и попробуйте снова.");
        });
    });
});

// Простая плавная прокрутка
document.addEventListener('DOMContentLoaded', function() {
    // Плавная прокрутка для якорных ссылок
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Анимация при наведении на услуги
    document.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Анимация для отзывов
    document.querySelectorAll('.review-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}